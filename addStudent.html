
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hall Ticket</title>
    <style>
       @media print {
            .page-break {
                page-break-after: always;
            }
            .print-button, .generate-button {
                display: none;
            }
            body {
                font-family: Arial, sans-serif;
                padding: 5mm;
                margin: 0;
            }
            #switch{
            display : none;
        }
        }

        h3, h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
        }

        .details {
            display:flex;
            justify-content:space-between;
            margin: 0;
            padding: 10px;
            border: 1px solid black;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .details .photo {
            position:relative;
            margin-top: 10px;
            margin-right: 20px;
            width: 150px;
            height: 180px;
            border: 1px solid #000;
            padding:5px;
            object-fit: cover;
            z-index: index -600;
        }

        .photo img {
            padding:7px;
            width: 150px;
            height:180px;
            object-fit: cover;
        }

        .timetable {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
        }

        .timetable th, .timetable td {
            border: 1px solid #000;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        

        .watermark {
            mix-blend-mode: color-burn;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.4;
            pointer-events: none;
        }

        .watermark img {
            width: 700px;
            height: 700px;
        }
        
        #title h2{
            margin:1px;
        }
       


        .hall-ticket {
            border: 2px solid #000;
            padding: 8px;
            width: 210mm;
            min-height: 290mm;
            
            padding: 8px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
            width: 210mm;
            height: 297mm;
            box-sizing: border-box;
            position: relative;
        }

        

        .footer {
            position: absolute;
            font-size: 12px;
            color: #555;
            text-align: center !important;
            justify-content: center;
            bottom: 1px;
        }

        .print-button, .generate-button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        table {
            margin: auto;
  border-collapse: collapse;
  
  width: 100%; /* Adjust the width as needed */
}
#examschedule table{
    max-width: 500px;
}

th, td {
  border: 1px solid black;
  padding: 5px;
  text-align: left;
}

th {
  background-color: #f2f2f2;
}
tr:nth-child(even) {
  background-color: #f2f2f2;
}
input {
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

button {
  padding: 10px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

button:hover {
  background-color: #3e8e41;
}
    </style>
</head>
<body>
    <div id="waitinganimation">
<style>
#loading-overlay {
position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent overlay */
 display: flex;
 justify-content: center;
 align-items: center;
 z-index: 9999; /* Ensure it's on top */
}

.hidden {
 display: none;
}

.loader {
 border: 4px solid rgba(0, 0, 0, 0.1);
 border-top: 4px solid #3498db;
 border-radius: 50%;
 width: 40px;
 height: 40px;
 animation: spin 2s linear infinite;
}

@keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
}

.confirm-container {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
  z-index: 9999; /* High z-index to ensure it's on top */
}

.button-container {
  display: flex;
  justify-content: space-around;
  margin-top: 20px;
}

.yes-button, .no-button {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.yes-button {
  background-color: #4CAF50;
  color: white;
}

.no-button {
  background-color: #f44336;
  color: white;
}
h2{
font-family:sans-serif;
}
.comment-container {
  margin-top: 20px;
}
#classList{
    max-width: fit-content;
    overflow: auto;
}
#classList table {
  border-collapse: collapse;
  width: 100%;
  
}

#classList th, td {
  border: 1px solid black;
  padding: 8px;
  text-align: left;
}

#classList th {
  background-color: #f2f2f2;
  font-weight: bold;
}

#classList tbody tr:nth-child(even) {
  background-color: #f2f2f2;
}

/* Responsive Design */
@media (max-width: 768px) {
  #classList table {
    font-size: 0.8em;
  }
}
.printed{
    background-color: #3e8e41 !important;
}
</style>
<div id="loading-overlay" style="display:none;">
 <div class="loader"></div>
</div>

<script>
  
function showLoading() {
 document.getElementById("loading-overlay").style.display="block";
}

function hideLoading() {
document.getElementById("loading-overlay").style.display="none";
 //document.getElementById("loading-overlay").classList.add("hidden");
}
</script>
</div>


<script>

  document.getElementById("togglePhoto").addEventListener("change", function () {
  if (this.checked) {
   // generateHallTicketsphotos(); // Call the function when toggle is switched on
  } else {
   // clearPhoto(); // Optional: Clear the photo output when toggle is off
  }
});

  </script>
    <!-- Generate and Print Buttons -->
     <div id="switch">    
       <input type="text" placeholder="enterClass" id="classSelect">
       <input type="text" placeholder="divisions"id="division">
       <button id="fetch" onclick="fetchData();">fetchdetails</button>
       <label for="togglePhoto">Load Photo:</label>
  <input type="checkbox" id="togglePhoto" />
       <div style="overflow-y: auto;overflow-y: auto; display: flex;gap: 30px; max-height: 500px;">
       <div id="examschedule"></div>
       <div id="classList"></div>
       </div>
       <div style="display: flex; gap: 3px;">
        <button class="generate-button" onclick="generateAllHallTickets()">Generate Hall Tickets</button>
    
        <button class="print-button" onclick=" hideSwitch()">Print All Hall Tickets</button>
    </div>
    </div>



    <!-- Container for Hall Tickets -->
    <div id="hallTicketsContainer" style="max-height: 9ovh; overflow: auto; width: 21cm; margin: auto;"></div>
   <div id="confirmContainer" class="confirm-container">
  <h2>Are you sure print the hall ticket?</h2>
  <div class="button-container">
    <button class="yes-button" onclick="savePrintedData();">Yes</button>
    <button class="no-button" onclick="hideConfirmation();">No</button>
  </div>
  <div class="comment-container">
    <!-- <label for="comment">Comment:</label>
    <textarea id="comment" rows="4" cols="50"></textarea> -->
  </div>
</div>
    <script>
      hideConfirmation();
      function showConfirmation() {
  document.getElementById('confirmContainer').style.display = 'block';
}

function hideConfirmation() {
  document.getElementById('confirmContainer').style.display = 'none';
}
//fetchData();

        function fetchData(){
        showLoading();
        loadExamSchedule();
        loadStudentTable();
        //hideLoading();
        
        }
        
       function hideSwitch() {
  document.getElementById("switch").style.display = "none";
  
  window.print();

  // Wait for 2 seconds before showing the switch again
  setTimeout(() => {
    document.getElementById("switch").style.display = "block";
    showConfirmation();
  }, 2000);
}
        const classTimetables = {
            "8": [
                { date: "2024-11-15", day: "Monday", subject: "Math", time: "9:00 AM - 12:00 PM" },
                { date: "2024-11-16", day: "Tuesday", subject: "English", time: "9:00 AM - 12:00 PM" },
                { date: "2024-11-17", day: "Wednesday", subject: "Science", time: "9:00 AM - 12:00 PM" }
            ],
            "11": [
                { date: "2024-11-15", day: "Friday", subject: "Physics", time: "9:00 AM - 12:00 PM" },
                { date: "2024-11-16", day: "Saturday", subject: "Chemistry", time: "9:00 AM - 12:00 PM" }
            ]
        };

        var studentsData = [
            { examNo: "B1234", name: "John Doe", admissionNo: "12345", class: "8", division: "A", classTeacher: "Ms. Smith", photoURL: "1251.jpg" },
            { examNo: "B5678", name: "Jane Smith", admissionNo: "67890", class: "8", division: "B", classTeacher: "Mr. Brown", photoURL: "1252.jpg" },
            { examNo: "B9101", name: "Emily Davis", admissionNo: "54321", class: "11", division: "A", classTeacher: "Dr. Green", photoURL: "1253.jpg" }
        ];
        var examName = "";
        var examSchedule=[];
        var classTeacher=[];
        var photofile = [];
         renderStudentTable(studentsData); // Render the table
        generateHallTicketHTML(studentData);
        generateExamScheduleTable(examSchedule);
        function loadExamSchedule() {
        showLoading();
    //const spinner = document.getElementById('spinner');
    //spinner.style.display = 'block';
   // console.log("data");
    // Get the current year from the input
    const selectedClass =document.getElementById("classSelect").value; // Ensure it's a string
    const division =document.getElementById("division").value; // Ensure it's a string

    fetch(`https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec?action=getExamSchedule&selectedClass=${selectedClass}`)
        .then(response => response.json())
        .then(data => {
            if (data.examSchedule && data.examSchedule.length > 0) {
                examSchedule = data.examSchedule; // Store data in the variable
                examName = data.examName;
                console.log(examSchedule);
              //  renderStudentTable(studentsData); // Render the table
             // generateHallTicketHTML(studentData);
             generateExamScheduleTable(examSchedule);
            } else {
            console.log(data);
                document.getElementById('studentTableContainer').innerHTML = '<p>No students found</p>';
            }
        })
        .catch(error => console.error('Error:', error))
        .finally(() =>""); //spinner.style.display = 'none');
}

function generateExamScheduleTable(schedule) {
  // ... (same as before)
  var index = 0;
const timetableRows = schedule.map((item ,index)=>
 `
    <tr>
    <td>${index+1}</td>
      <td>${formatDate(item.date)}</td>
      <td>${item.day}</td>
      <td>${item.class}</td>
      <td>${item.subject}</td>
      <td>${item.time}</td>
      <td></td>
    </tr>
  `).join('');

  const tableHTML = `
    <table border="1">
        <thead>
          <tr>
          <th>sl</th>
            <th>Date</th>
            <th>Day</th>
            <th>Subject</th>
            <th>Time</th>
            <th>Signature</th>
          </tr>
        </thead>
        <tbody>
          ${timetableRows}
        </tbody>
      </table>
    </div>
  `;

  // Get the division with the ID "examschedule"
  const examscheduleDiv = document.getElementById('examschedule');

  // Set the inner HTML of the division to the generated table HTML
  examscheduleDiv.innerHTML = tableHTML;
  hideLoading();
}

function generateClassList(schedule) {
  // ... (same as before)
showLoading();
const studentRows = schedule.map((item, index) => {
  const isHallTicketIssued = item.hallticket === "YES";
  const hallTicketClass = isHallTicketIssued ? 'printed' : '';

  return `
    <tr class="${hallTicketClass}">
      <td>${index + 1}</td>
      <td>${item.adNumber}</td>
      <td>${item.name}</td>
      <td>${item.gender}</td>
      <td>${item.stuClass}</td>
      <td>${item.division}</td>
      <td>${item.examCode}</td>
      <td>${item.feeBalance > 1000 || item.feeBalance !== "Request for pay later" ? "YES" : "NO"}${item.feeBalance}</td>
      <td class="${hallTicketClass}">${isHallTicketIssued ? "YES" : "NO"}</td>
    </tr>
  `;
}).join('');
  const tableHTML = `
    <table border="1" class="classList">
        <thead>
          <tr>
            <th>SL</th>
            <th>AdNumber</th>
            <th>Name</th>
            <th>Gender</th>
            <th>class</th>
            <th>Division</th>
            <th>Exam Code</th>
            <th>Fee Pending</th>
            <th> printed</th>
          </tr>
        </thead>
        <tbody>
          ${studentRows}
        </tbody>
      </table>
    </div>
  `;

  // Get the division with the ID "examschedule"
  const examscheduleDiv = document.getElementById('classList');

  // Set the inner HTML of the division to the generated table HTML
  examscheduleDiv.innerHTML = tableHTML;
  hideLoading();
}
function loadStudentTable() {
    //const spinner = document.getElementById('spinner');
    //spinner.style.display = 'block';
    
    // Get the current year from the input
    const selectedClass =document.getElementById("classSelect").value; // Ensure it's a string
    const division = document.getElementById("division").value; // Ensure it's a string
console.log(selectedClass+division);
    fetch(`https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec?action=gethallTicket&selectedClass=${selectedClass}&division=${division}`)
        .then(response => response.json())
        .then(data => {
            if (data.students && data.students.length > 0) {
                studentsData = data.students; // Store data in the variable
                classTeacher = data.classTeacher;
                console.log(classTeacher);
              //  renderStudentTable(studentsData); // Render the table
              generateClassList(studentsData);
            } else {
              //  document.getElementById('studentTableContainer').innerHTML = '<p>No students found</p>';
            }
        })
        .catch(error => console.error('Error:', error))
        .finally(() =>console.error("SOMETHING WRONG")); //spinner.style.display = 'none');
}
        function generateHallTicketHTML(studentData) {
        var divId= "photo" + studentData.adNumber
        const imageGet = {
        photoId:studentData.photoId,
    adNumber: studentData.adNumber,
    divId: "photo" + studentData.adNumber
  };
  photofile.push(imageGet);

        const image = "https://drive.google.com/uc?export=view&id=1j7aMhS463vC_tGexzzXbtQSVICk7aHwf";
            const schedule = examSchedule;
            const exam=examName;
            const teacher = classTeacher[0].name; // Accesses the name of the first teacher
            console.log(schedule)
            const timetableRows = schedule.map(item => `
                <tr>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.day}</td>
                    <td>${item.subject}</td>
                    <td>${item.time}</td>
                    <td></td>
                </tr>
            `).join('');

            return `
                <div class="hall-ticket page-break">
            <!-- Watermark -->
<div class="watermark"><img src="emblom.png" alt="Emblem"></div>

<!-- Header with School Logo -->
<div style="display:flex;">
 <div id="pmsa" style="z-index:-900; position:absolute; left:5px; top: 20px; mix-blend-mode: color-burn;border-radius:50%">
     <img src="KYHSSLOGO.jpg" width="200" height="200" alt="School Logo">    
 </div>
 <div id="title" style="gap:3px;">
     <h2 style="margin-bottom: 30px; font-family:Arial, Helvetica, sans-serif">KATTILANGADI YETHEEMKHANA HIGHER SECONDARY SCHOOL<br>ATHAVANAD-19094</h2>
    <div style=" top: auto;font-family: sans-serif; padding: 7px; background-color: #000; width: 250px; margin: auto; border-radius: 10% / 50%; text-align: center;">
<h2 style="font-weight: bolder; color: #f2f2f2; margin: 0;">HALL TICKET</h2>
</div>
 </div>
</div>
<h3 style="margin:20px; margin-bottom: 10px;">${exam}_2024-25</h3>

<div class="details">
                 <div id="studentInfo">
                     <h3 style="text-align:right;margin-right:-90px;"><strong>Exam Register No:</strong> ${studentData.examCode}</h3>
                     <p>Student Name:<strong> ${studentData.name}</strong></p>
                     <p>Admission number:<strong> ${studentData.adNumber}</strong></p>
                     <span style="display:flex;gap:40px;">
                     <p>Class: <strong style="left:20px;">${studentData.stuClass}</strong></p>
                     <p>Division : <strong>${studentData.division}</strong></p>
                     </span>
                     <p><strong>Signature Of Candidate</strong> - - - - - - - - - - - - - - - - -</p>
                 </div>
 
 <div class="photo" id="photoContainer">
      <img id="${divId}" src="https://drive.google.com/thumbnail?id=${studentData.photoId}&sz=800" alt="Student Photo" id="studentPhoto" >
 </div>
</div>

<h3>Exam Schedule</h3>
                
             <table class="timetable">
                 <thead>
                     <tr>
                         <th>Date</th>
                         <th>Day</th>
                         <th>Subject</th>
                         <th>Time</th>
                         <th>Sign of Invigilator</th>
                     </tr>
                 </thead>
                 <tbody>${timetableRows}</tbody>
             </table>
            <div id="signature">
 <p style="display: flex; justify-content: space-between; padding: 30px 30px;">
     <span style="display: flex;flex-direction: column;gap:20px;">Sign of the Class Teacher <span><b id="classTeacher">${teacher}</b></span></span>
     <span>School Seal</span>
     <span style="display: flex;flex-direction: column; gap:0px;">Sign of the Principal <span><b>MUNEER KAPPAN</b></span></span>
 </p>
 <div style="display: flex; gap: 100px;"> 
 <div style="border-radius:50%; position:relative; top:-69px; left: 50%; right: 50%; transform: translate(-50%, -50%); width: 150px; height: 150px; overflow: hidden; background-color: lightgray; mix-blend-mode: color-burn; z-index: -100;">
     <img src="SEAL.jpg" alt="Seal" style="width: 100%; height: 100%; mix-blend-mode: hard-light; background-color: #fcfafa;">
 </div>
 <div style=" position:relative; top:-50px; left: 55%; right: 50%; transform: translate(-50%, -50%); width: 200px; height: 100px; overflow: hidden; background-color: lightgray; mix-blend-mode: color-burn; z-index: -100; ">
    <img src="sign3.jpg" alt="Seal" width="200px" height="100px">
</div>
</div>
</div>
             <div class="footer">
 <p>KATTILANGADI YATHEEMKHANA HIGHER SECONDARY SCHOOL ATHAVANAD, MOB: 9447570250 GMAIL: KYHSSCHOOL@GMAIL.COM</p>
</div>
         </div>
            `
            ;
            
        }
async function generateHallTicketsphotos() {
  for (const imageGet of photofile) {
    const studentId = imageGet.adNumber;
    const imgId = imageGet.divId;
    const photo = imageGet.photoId;

    try {
    const toggle = document.getElementById("togglePhoto");
  
  if (!toggle.checked) {
    console.warn("Toggle is not checked. Function will not run."); // Debug message
    return; // Exit the function if not checked
}
      //await loadStudentPhotos( photo,studentId, imgId);
    } catch (error) {
      console.error(`Error loading photo for student ${studentId}:`, error);
    }
  }
}

async function loadStudentPhotos(photo,studentId, imgId) {
    try {
       // const response = await fetch(`https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec?action=getStudentPhoto&studentId=${studentId}`);
        const response = await fetch(`https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec?action=getPhotoById&photoId=${photo}`);
        
        const data = await response.json();
            //console.log(data);
        if (data.photo) {
            // Set the src attribute of the img tag to the Base64 encoded string
            document.getElementById(imgId).src = `data:image/jpeg;base64,${data.photo}`;
           //console.log(data.photo);
          //  document.getElementById('error-message').textContent = ''; // Clear any previous error messages
        } else if (data.error) {
          //  document.getElementById('error-message').textContent = data.error; // Show error message
        }
    } catch (error) {
        console.error('Error fetching photo:', error);
        document.getElementById('error-message').textContent = 'Failed to fetch photo.';
    }
}

function savePrintedData() {
    showLoading();
    const id = photofile.map(element => element.adNumber); // Extract IDs

// Create an object with action and ids properties
const data = {
  actions: "printedData",
  ids: id
};

// Convert the object to URLSearchParams
const params = new URLSearchParams(data).toString();
            fetch(`https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec?action=printedData&${params}`)
                .then(response => response.json())
                .then(data => {
      if (data.success) {
        console.log("Success");
        // Optional: Call any functions to refresh UI or data, e.g., loadStudentTable();
      } else {
        alert('Error updating hall ticket statuses.');
      }
    })
    .catch(error => console.error('Error:', error))
    .finally(() => {
      // Hide the spinner if it exists
      hideLoading();
      loadStudentTable();
      hideConfirmation()
    });
}
// Assuming photofile is an array containing objects with adNumber and divId
function generateAllHallTickets() {
  const container = document.getElementById("hallTicketsContainer");
  container.innerHTML = ""; // Clear existing content before generating new tickets

  const filteredStudents = studentsData.filter(student => {
    return student.hallticket!=="YES";//&&(student.feeBalance < 1000 || student.feeBalance === "Request for pay later");
  });

  photofile = []; // Reset photofile array before populating new data

  const hallTicketHTML = studentsData.map(student => generateHallTicketHTML(student));
  container.innerHTML = hallTicketHTML.join('');

 // generateHallTicketsphotos(); // Assuming generateHallTicketsphotos handles photos
}
        function generateAllHallTickets33() {
            const container = document.getElementById("hallTicketsContainer");
            photofile=[];
            container.innerHTML = studentsData.map(student => 
            generateHallTicketHTML(student)).join('');
            generateHallTicketsphotos();
        }
        function formatDate(dateString) {
    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', options); // Format as "DD/MM/YYYY"
}
    </script>

    <div>
        
    </div>
</body>
</html>
